name: test
on:
  push:
    tags: ["v*"]
    branches: ["main", "mise"]
  pull_request:
    branches: ["main"]
  workflow_dispatch:
  workflow_call:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.event_name != 'push' }}

env:
  CARGO_TERM_COLOR: always
  MISE_TRUSTED_CONFIG_PATHS: ${{ github.workspace }}
  MISE_EXPERIMENTAL: 1
  MISE_LOCKFILE: 1
  RUST_BACKTRACE: 1
  MISE_AQUA_GITHUB_ATTESTATIONS: "false"
  GITHUB_TOKEN: ${{ secrets.MISE_GH_TOKEN || secrets.GITHUB_TOKEN }}
  FORGEJO_TOKEN: ${{ secrets.FORGEJO_TOKEN }}

permissions:
  pull-requests: write

jobs:
  build-ubuntu:
    runs-on: ubuntu-24.04
    timeout-minutes: 60
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
      - name: Install Lua 5.1 dev package
        run: |
          sudo apt-get update
          sudo apt-get install -y liblua5.1-0-dev pkg-config
      - uses: Swatinem/rust-cache@98c8021b550208e191a6a3145459bfc9fb29c4c0 # v2
        with:
          shared-key: build
          save-if: false
      - run: |
          cargo build --all-features
          echo "$PWD/target/debug" >> "$GITHUB_PATH"
      - run: mise -v
      - uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: mise-ubuntu-24-04
          path: target/debug/mise
      - uses: ./.github/actions/mise-tools

  build-windows:
    runs-on: windows-2022
    timeout-minutes: 60
    env:
      MISE_DATA_DIR: ~/.local/share/mise
      MISE_CACHE_DIR: ~/.cache/mise
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
      - uses: Swatinem/rust-cache@98c8021b550208e191a6a3145459bfc9fb29c4c0 # v2
        with:
          shared-key: build
          save-if: ${{ github.ref == 'refs/heads/main' }}
      - shell: pwsh
        run: |
          cargo build
          Add-Content $env:GITHUB_PATH "$env:GITHUB_WORKSPACE\target\debug"
      - run: mise -v
      - uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: mise-windows-2022
          path: target/debug/mise.exe
      - uses: ./.github/actions/mise-tools

  unit:
    strategy:
      fail-fast: false
      # matrix: { os: [ubuntu-24.04, macos-14] }
      matrix: { os: [macos-14] }
    runs-on: ${{ matrix.os }}
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          repository: ${{ github.event.pull_request.head.repo.full_name }}
          ref: ${{ github.head_ref }}
      - uses: Swatinem/rust-cache@98c8021b550208e191a6a3145459bfc9fb29c4c0 # v2
        with:
          shared-key: build
          save-if: ${{ github.ref == 'refs/heads/main' }}
      - run: |
          cargo build --all-features
          echo "$PWD/target/debug" >> "$GITHUB_PATH"
      - uses: ./.github/actions/mise-tools
      - run: mise x -- cargo test --all-features

  lint:
    runs-on: ubuntu-24.04
    timeout-minutes: 15
    needs: [build-ubuntu]
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          repository: ${{ github.event.pull_request.head.repo.full_name }}
          ref: ${{ github.head_ref }}
      - name: Install Lua 5.1 dev package
        run: |
          sudo apt-get update
          sudo apt-get install -y liblua5.1-0-dev pkg-config
      - uses: rui314/setup-mold@725a8794d15fc7563f59595bd9556495c0564878 # v1
      - uses: taiki-e/install-action@45a93d9c71692daf99a53feb97366fb6f4c3757f # v2
        with:
          tool: cargo-deny@0.19.0,cargo-msrv@0.18.4,cargo-machete@0.9.1
      - uses: Swatinem/rust-cache@98c8021b550208e191a6a3145459bfc9fb29c4c0 # v2
        with:
          shared-key: build
          save-if: ${{ github.ref == 'refs/heads/main' }}
      - uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4
        with:
          name: mise-ubuntu-latest
          path: target/debug
      - run: echo "$PWD/target/debug" >> "$GITHUB_PATH" && chmod +x target/debug/mise
      - uses: ./.github/actions/mise-tools
      - run: mise x -- bun i
      - run: rm -rf ~/.cargo/advisory-dbs && cargo deny check
      - run: cargo msrv verify
      - run: cargo machete --with-metadata
      - run: ./scripts/test-standalone.sh
      - run: mise run lint
      - run: cargo clippy -- -D warnings
      - run: cargo clippy --all-features --all-targets -- -D warnings

  windows-unit:
    runs-on: windows-latest
    timeout-minutes: 30
    env:
      MISE_DATA_DIR: ~/.local/share/mise
      MISE_CACHE_DIR: ~/.cache/mise
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
      - uses: Swatinem/rust-cache@98c8021b550208e191a6a3145459bfc9fb29c4c0 # v2
        with:
          shared-key: build
          save-if: ${{ github.ref == 'refs/heads/main' }}
      - name: cargo test
        uses: nick-fields/retry@ce71cc2ab81d554ebbe88c79ab5975992d79ba08 # v3
        with:
          timeout_minutes: 30
          retry_wait_seconds: 30
          max_attempts: 2
          command: cargo test

  windows-e2e:
    runs-on: windows-2022
    timeout-minutes: 40
    needs: [build-windows]
    env:
      MISE_DATA_DIR: ~/.local/share/mise
      MISE_CACHE_DIR: ~/.cache/mise
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
      - uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4
        with:
          name: mise-windows-latest
          path: target/debug
      - run: Add-Content $env:GITHUB_PATH "$env:GITHUB_WORKSPACE\target\debug"
      - uses: ./.github/actions/mise-tools
      - name: e2e
        uses: nick-fields/retry@ce71cc2ab81d554ebbe88c79ab5975992d79ba08 # v3
        with:
          timeout_minutes: 30
          retry_wait_seconds: 30
          max_attempts: 2
          command: pwsh e2e-win\run.ps1

  test-ci:
    runs-on: ubuntu-24.04
    timeout-minutes: 1
    needs:
      - build-ubuntu
      - build-windows
      - unit
      - lint
      - windows-unit
      - windows-e2e
    if: always()
    steps:
      - name: Check CI job results
        run: |
          if [ "${{ needs.build-ubuntu.result }}" != "success" ]; then
            echo "build-ubuntu failed or was skipped"
            exit 1
          fi
          if [ "${{ needs.build-windows.result }}" != "success" ]; then
            echo "build-windows failed or was skipped"
            exit 1
          fi
          if [ "${{ needs.unit.result }}" != "success" ]; then
            echo "unit failed or was skipped"
            exit 1
          fi
          if [ "${{ needs.lint.result }}" != "success" ]; then
            echo "lint failed or was skipped"
            exit 1
          fi
          if [ "${{ needs.windows-unit.result }}" != "success" ]; then
            echo "windows-unit failed or was skipped"
            exit 1
          fi
          if [ "${{ needs.windows-e2e.result }}" != "success" ]; then
            echo "windows-e2e failed or was skipped"
            exit 1
          fi
          echo "All CI jobs completed successfully"
